rules:
  - id: wp-missing-capability-check
    languages: [php]
    pattern-either:
      # Function-based callback
      - patterns:
          - pattern: |
              add_action('$ACTION', '$HOOKFUNC');
          - metavariable-regex:
              metavariable: $ACTION
              regex: ^(wp_ajax_nopriv_|wp_ajax_|admin_)
          - pattern-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                current_user_can(...);
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                if (current_user_can(...)) { ... }
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                if (!current_user_can(...)) { ... }
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                user_can(...);
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                current_user_can_for_blog(...);
                ...
              }
              ...
      # Method-based callback (array syntax)
      - patterns:
          - pattern-either:
              - pattern: add_action('$ACTION', array($THIS, '$HOOKFUNC'));
              - pattern: add_action('$ACTION', [$THIS, '$HOOKFUNC']);
          - metavariable-regex:
              metavariable: $ACTION
              regex: ^(wp_ajax_nopriv_|wp_ajax_|admin_)
          - pattern-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  current_user_can(...);
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  if (current_user_can(...)) { ... }
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  if (!current_user_can(...)) { ... }
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  user_can(...);
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  current_user_can_for_blog(...);
                  ...
                }
                ...
              }
    message: "WordPress action handler '$HOOKFUNC' for '$ACTION' is missing capability check (current_user_can, user_can, or current_user_can_for_blog)"
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-862"
      owasp: "A01:2021"
      references:
        - "https://developer.wordpress.org/plugins/security/checking-user-capabilities/"
