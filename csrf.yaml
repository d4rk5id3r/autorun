rules:
  - id: wp-wpajax-no-csrf
    languages: [php]
    pattern-either:
      # Function-based callback
      - patterns:
          - pattern: |
              add_action('$ACTION', '$HOOKFUNC');
          - metavariable-regex:
              metavariable: $ACTION
              regex: ^(wp_ajax_nopriv_|wp_ajax_)
          - pattern-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                check_ajax_referer(...);
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                check_admin_referer(...);
                ...
              }
              ...
          - pattern-not-inside: |
              ...
              function $HOOKFUNC(...) {
                ...
                wp_verify_nonce(...);
                ...
              }
              ...
      
      # Method-based callback (array syntax)
      - patterns:
          - pattern-either:
              - pattern: add_action('$ACTION', array($THIS, '$HOOKFUNC'));
              - pattern: add_action('$ACTION', [$THIS, '$HOOKFUNC']);
          - metavariable-regex:
              metavariable: $ACTION
              regex: ^(wp_ajax_nopriv_|wp_ajax_)
          - pattern-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  check_ajax_referer(...);
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  check_admin_referer(...);
                  ...
                }
                ...
              }
          - pattern-not-inside: |
              class $CLASS {
                ...
                public function $HOOKFUNC(...) {
                  ...
                  wp_verify_nonce(...);
                  ...
                }
                ...
              }
    
    message: "WordPress AJAX action '$ACTION' handler '$HOOKFUNC' does not call CSRF protection (check_ajax_referer, check_admin_referer, or wp_verify_nonce)"
    severity: WARNING
    metadata:
      category: security
      cwe: "CWE-352"
      owasp: "A01:2021"